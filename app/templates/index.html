{% extends "layout.html" %}
{% block title %}CryptoFlow Dashboard{% endblock %}
{% block content %}
<div class="page-content mt-4"> {# page-content for consistent background/padding, mt-4 for spacing from navbar #}
    <div class="dashboard-section">
        <h2>Token Pools (SOL Pairs)</h2>
        <div class="search-container-main">
            <input type="text" id="search-input" class="form-control" placeholder="Search token pools..."> {# Added
            form-control #}
            <div class="search-dropdown" id="search-dropdown"></div>
        </div>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4" id="token-list"> {# Bootstrap grid
            classes #}
        </div>
    </div>
</div>

<div class="modal fade" id="chart-modal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered"> {# modal-xl for a larger chart modal #}
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chartModalLabel">Biểu đồ Token</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <canvas id="token-chart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tokenList = document.getElementById('token-list');
        const chartModal = new bootstrap.Modal(document.getElementById('chart-modal')); // Initialize Bootstrap modal
        const chartCanvas = document.getElementById('token-chart').getContext('2d');
        let chartInstance = null;

        async function fetchTokenData() {
            try {
                const response = await fetch('https://api.orca.so/v1/pools');
                const data = await response.json();

                const pools = Object.values(data);

                const solPools = pools.filter(pool => pool.name.endsWith('/SOL'));

                const tokens = solPools.map(pool => {
                    return {
                        name: pool.name.split('/')[0],
                        current_price: pool.price || 0,
                        price_change_percentage_24h: (Math.random() * 20 - 10).toFixed(2), // Mock data for change
                        total_volume: pool.volume.h24 || 0,
                        market_cap: pool.liquidity || 0
                    };
                });

                updateTokenList(tokens);
            } catch (error) {
                console.error('Error fetching token data:', error);
            }
        }

        function updateTokenList(tokens) {
            tokenList.innerHTML = '';

            tokens.forEach(token => {
                const colDiv = document.createElement('div');
                colDiv.className = 'col'; // Bootstrap column for card grid
                const tokenItem = document.createElement('div');
                tokenItem.className = 'card h-100'; // h-100 to make cards same height
                tokenItem.innerHTML = `
                    <div class="card-body">
                        <h3 class="card-title">${token.name} / SOL</h3>
                        <div class="data-value">$${token.current_price.toFixed(2)}</div>
                        <div class="change ${token.price_change_percentage_24h >= 0 ? 'positive' : 'negative'}">
                            ${token.price_change_percentage_24h}%
                        </div>
                        <p class="card-text">Volume: $${token.total_volume.toLocaleString()}</p>
                        <p class="card-text">Liquidity: $${token.market_cap.toLocaleString()}</p>
                    </div>
                `;
                colDiv.appendChild(tokenItem);
                tokenList.appendChild(colDiv);
            });
        }

        // Event listener for opening the chart modal
        // This assumes you click on a token card to open the chart.
        // You'll need to add a click listener to your dynamically created token cards
        // and trigger chartModal.show() with relevant data.
        // For demonstration, here's a placeholder if you had a button:
        // document.getElementById('open-chart-button').addEventListener('click', () => {
        //     chartModal.show();
        //     // Logic to load chart data here
        // });

        fetchTokenData();
        setInterval(fetchTokenData, 60000);
    });
</script>
{% endblock %}
